<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>AR.js Chatbot (GitHub Pages)</title>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, user-scalable=no"
  />

  <!-- A-Frame & AR.js (Hiro ë§ˆì»¤ìš©) -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #000;
    }

    #app {
      position: relative;
      width: 100%;
      height: 100%;
    }

    /* AR ì˜ì—­ (ì „ì²´ ë°°ê²½) */
    #ar-wrapper {
      position: absolute;
      inset: 0;
    }

    /* =======================
       ì±„íŒ… UI ì˜¤ë²„ë ˆì´
    ======================== */
    #chat-panel {
      position: absolute;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      width: 90%;
      max-width: 420px;
      background: rgba(0, 0, 0, 0.65);
      border-radius: 16px;
      padding: 12px;
      backdrop-filter: blur(6px);
      color: #fff;
    }

    #chat-messages {
      max-height: 160px;
      overflow-y: auto;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .chat-line + .chat-line {
      margin-top: 4px;
    }

    .chat-line.user {
      text-align: right;
    }

    .chat-line.bot {
      text-align: left;
    }

    #chat-form {
      display: flex;
      gap: 6px;
    }

    #chat-input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
    }

    #chat-send {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }

    #chat-send:disabled {
      opacity: 0.6;
      cursor: default;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- AR ì”¬ -->
    <div id="ar-wrapper">
      <a-scene
        embedded
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; antialias: true;"
        arjs="sourceType: webcam; debugUIEnabled: false;"
      >
        <!-- Hiro ë§ˆì»¤ -->
        <a-marker preset="hiro">
          <a-box
            position="0 0.5 0"
            depth="0.5"
            height="0.5"
            width="0.5"
            color="#4CC3D9"
          ></a-box>

          <a-text
            value="ì•ˆë…•í•˜ì„¸ìš”! AR ì±—ë´‡ì…ë‹ˆë‹¤."
            position="-0.8 0.1 0"
            rotation="-90 0 0"
            color="#FFFFFF"
            width="3"
          ></a-text>
        </a-marker>

        <!-- ì¹´ë©”ë¼ -->
        <a-entity camera></a-entity>
      </a-scene>
    </div>

    <!-- ì±„íŒ… UI -->
    <div id="chat-panel">
      <div id="chat-messages">
        <div class="chat-line bot">
          Hiro ë§ˆì»¤ë¥¼ ì¹´ë©”ë¼ì— ë¹„ì¶”ë©´ ìƒìê°€ ë³´ì—¬ìš”. ê¶ê¸ˆí•œ ê±¸ ë¬¼ì–´ë³´ì„¸ìš”!
        </div>
      </div>
      <form id="chat-form">
        <input
          id="chat-input"
          type="text"
          autocomplete="off"
          placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
        />
        <button id="chat-send" type="submit">ì „ì†¡</button>
      </form>
    </div>
  </div>

  <script>
    // ======= ì±„íŒ… í´ë¼ì´ì–¸íŠ¸ (GitHub Pages + ngrok ë°±ì—”ë“œìš©) =======
    const messagesEl = document.getElementById("chat-messages");
    const formEl = document.getElementById("chat-form");
    const inputEl = document.getElementById("chat-input");
    const sendBtn = document.getElementById("chat-send");

    // ğŸ‘‰ ì—¬ê¸° ì£¼ì†Œë¥¼ ë„¤ ngrok https ì£¼ì†Œë¡œ ë§ì¶°ì¤˜ì•¼ í•¨
    // ì˜ˆì‹œ: https://largando-conner-unprecedented.ngrok-free.dev/chat
    const API_BASE_URL =
      "https://largando-conner-unprecedented.ngrok-free.dev/chat";

    function appendMessage(text, role) {
      const div = document.createElement("div");
      div.className = "chat-line " + role;
      div.textContent = text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    formEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = inputEl.value.trim();
      if (!text) return;

      appendMessage(text, "user");
      inputEl.value = "";
      sendBtn.disabled = true;

      try {
        const resp = await fetch(API_BASE_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: text,
            model: "gpt-4.1",
            max_tokens: 500,
            temperature: 0.9,
          }),
        });

        if (!resp.ok) {
          throw new Error("HTTP " + resp.status);
        }

        const data = await resp.json();

        // ë°±ì—”ë“œ ì‘ë‹µ í˜•ì‹ì— ë§ì¶°ì„œ ê³¨ë¼ ì“°ê¸°
        const reply =
          data.message || data.reply || data.answer || JSON.stringify(data);

        appendMessage(reply, "bot");
      } catch (err) {
        console.error(err);
        appendMessage(
          "ë°±ì—”ë“œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ì–´ìš”. (ngrok URL / FastAPI ì„œë²„ í™•ì¸)",
          "bot"
        );
      } finally {
        sendBtn.disabled = false;
        inputEl.focus();
      }
    });
  </script>
</body>
</html>
